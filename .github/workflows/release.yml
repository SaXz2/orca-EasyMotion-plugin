name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Get plugin name and version
        id: info
        run: |
          PLUGIN_NAME=$(node -p "require('./package.json').name")
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "PLUGIN_NAME=$PLUGIN_NAME" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Create plugin package
        run: |
          mkdir -p ${{ steps.info.outputs.PLUGIN_NAME }}
          cp -r dist ${{ steps.info.outputs.PLUGIN_NAME }}/
          if [ -f icon.png ]; then cp icon.png ${{ steps.info.outputs.PLUGIN_NAME }}/; fi
          if [ -f README.md ]; then cp README.md ${{ steps.info.outputs.PLUGIN_NAME }}/; fi
          zip -r ${{ steps.info.outputs.PLUGIN_NAME }}.zip ${{ steps.info.outputs.PLUGIN_NAME }}
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.info.outputs.PLUGIN_NAME }}.zip
          body: |
            ## Orca EasyMotion Plugin v${{ steps.info.outputs.VERSION }}
            
            ### å®‰è£…æ–¹æ³•
            1. ä¸‹è½½ `${{ steps.info.outputs.PLUGIN_NAME }}.zip` æ–‡ä»¶
            2. è§£å‹åˆ° Orca çš„ `plugins` ç›®å½•
            3. åœ¨ Orca ä¸­å¯ç”¨æ’ä»¶
            
            ### ä½¿ç”¨æ–¹æ³•
            - åŒå‡» Alt é”®æ¿€æ´» EasyMotion
            - è¾“å…¥æœç´¢è¯ï¼ˆæ”¯æŒä¸­æ–‡ã€æ‹¼éŸ³ã€è‹±æ–‡ï¼‰
            - æŒ‰å­—æ¯é”®è·³è½¬åˆ°å¯¹åº”ä½ç½®
            
            ### åŠŸèƒ½ç‰¹æ€§
            - ğŸš€ åŒå‡» Alt æ¿€æ´»å¿«é€Ÿå¯¼èˆª
            - ğŸ” æ™ºèƒ½æœç´¢ï¼šæ”¯æŒä¸­æ–‡ã€æ‹¼éŸ³ã€è‹±æ–‡æ··åˆæœç´¢
            - ğŸ“ æ‹¼éŸ³åŒ¹é…ï¼šæ”¯æŒå®Œæ•´æ‹¼éŸ³ã€æ‹¼éŸ³é¦–å­—æ¯ã€éƒ¨åˆ†æ‹¼éŸ³
            - âŒ¨ï¸ å¿«é€Ÿè·³è½¬ï¼šå­—æ¯æ ‡è®°ï¼Œä¸€é”®åˆ°è¾¾
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
